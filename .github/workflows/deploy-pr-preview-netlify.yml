name: Deploy PR Preview to Netlify

on:
  workflow_run:
    workflows: ["Build PR Preview"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
            });

            const prNumberArtifact = artifacts.data.artifacts.find(
              artifact => artifact.name.startsWith('pr-number-')
            );

            if (!prNumberArtifact) {
              core.setFailed('Could not find PR number artifact');
              return;
            }

            const prNumber = prNumberArtifact.name.replace('pr-number-', '');
            core.setOutput('pr_number', prNumber);
            core.setOutput('artifact_name', `pr-preview-${prNumber}`);

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.pr.outputs.artifact_name }}
          path: ./dist
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Deploy to Netlify
        id: netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './dist'
          production-deploy: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "PR Preview #${{ steps.pr.outputs.pr_number }}"
          alias: pr-${{ steps.pr.outputs.pr_number }}
          enable-pull-request-comment: false
          enable-commit-comment: false
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.pr_number }}');
            const deployUrl = '${{ steps.netlify.outputs.deploy-url }}';
            const body = `ðŸš€ **Preview:** ${deployUrl}\nðŸ“ **Commit:** \`${{ github.event.workflow_run.head_sha }}\``;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview:')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
